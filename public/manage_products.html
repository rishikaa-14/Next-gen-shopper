<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Manage Products - NextGen Shopper</title>
  <link rel="stylesheet" href="styles.css" />
  <style>
    .products-section {
      padding: 2rem;
      max-width: 1000px;
      margin: auto;
    }

    .products-section h2 {
      text-align: center;
      margin-bottom: 1rem;
    }

    .form-inline {
      display: flex;
      gap: 10px;
      margin-bottom: 1rem;
    }

    .form-inline input {
      flex: 1;
      padding: 10px;
      font-size: 1rem;
      border: 1px solid #ccc;
      border-radius: 8px;
    }

    .form-inline button {
      background-color: #2563eb;
      color: white;
      border: none;
      padding: 10px 16px;
      border-radius: 8px;
      font-weight: bold;
      cursor: pointer;
    }

    #searchProductInput {
      width: 100%;
      padding: 12px;
      font-size: 1rem;
      border: 1px solid #ccc;
      border-radius: 8px;
      margin: 10px 0 20px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background-color: white;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }

    th, td {
      padding: 14px 20px;
      text-align: left;
    }

    th {
      background-color: #111827;
      color: white;
    }

    tr:nth-child(even) {
      background-color: #f9f9f9;
    }

    tr:hover {
      background-color: #f1f5f9;
    }

    .delete-btn {
      background-color: #ef4444;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
    }

    .toast-container {
      position: fixed;
      top: 1rem;
      right: 1rem;
      z-index: 1000;
    }

    .toast {
      padding: 12px 20px;
      border-radius: 6px;
      color: white;
      font-weight: 500;
      animation: slide-in 0.3s ease, fade-out 0.3s ease 2.7s forwards;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      font-size: 0.95rem;
      min-width: 200px;
      margin-bottom: 10px;
    }

    .toast.success { background-color: #16a34a; }
    .toast.error { background-color: #dc2626; }

    @keyframes slide-in {
      from { opacity: 0; transform: translateX(100%); }
      to { opacity: 1; transform: translateX(0); }
    }

    @keyframes fade-out {
      to { opacity: 0; transform: translateX(100%); }
    }
    .undo-btn {
      margin-left: 10px;
      background-color: #111827;
      color: white;
      border: none;
      padding: 5px 10px;
      border-radius: 4px;
      cursor: pointer;
    }
  </style>
</head>
<body>
    <header class="navbar">
      <h1>NextGen Shopper</h1>
      <nav>
        <a href="admin_dashboard.html">Dashboard</a>
        <a href="logout.html">Logout</a>
      </nav>
    </header>
  
    <section class="products-section">
      <h2>Manage Products</h2>
  
      <form class="form-inline" id="addProductForm">
        <input type="text" id="productName" placeholder="Product Name" required />
        <input type="number" id="productPrice" placeholder="Price" step="0.01" required />
        <button type="submit">Add</button>
      </form>
  
      <input type="text" id="searchProductInput" placeholder="Search products..." />
  
      <table>
        <thead>
          <tr>
            <th>Product Name</th>
            <th>Price</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="productTableBody"></tbody>
      </table>
    </section>
  
    <div id="toastContainer" class="toast-container"></div>
  
    <script>
      let allProducts = [];
      let recentlyDeleted = null;
      let deleteTimeout = null;
  
      const toast = (msg, success = true, undo = false) => {
        const container = document.getElementById('toastContainer');
        container.innerHTML = '';
        const el = document.createElement('div');
        el.className = `toast ${success ? 'success' : 'error'}`;
        el.innerHTML = msg;
  
        if (undo) {
          const btn = document.createElement('button');
          btn.innerText = "Undo";
          btn.className = 'undo-btn';
          btn.onclick = undoDelete;
          el.appendChild(btn);
        }
  
        container.appendChild(el);
        setTimeout(() => el.remove(), 5000);
      };
  
      async function fetchProducts() {
        const res = await fetch('/api/products');
        allProducts = await res.json();
        renderProducts(allProducts);
      }
  
      function renderProducts(products) {
        const tbody = document.getElementById('productTableBody');
        tbody.innerHTML = '';
        products.forEach(product => {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${product.name}</td>
            <td>â‚¹${parseFloat(product.price).toFixed(2)}</td>
            <td><button class="delete-btn" onclick="deleteProduct(${product.product_id}, this)">Delete</button></td>
          `;
          tbody.appendChild(row);
        });
      }
  
      async function deleteProduct(id, btn) {
        const row = btn.closest('tr');
        recentlyDeleted = {
          id,
          row,
          index: Array.from(row.parentElement.children).indexOf(row),
          name: row.children[0].innerText,
          price: row.children[1].innerText,
        };
  
        row.remove();
        toast(`Product "${recentlyDeleted.name}" deleted.`, true, true);
  
        deleteTimeout = setTimeout(async () => {
          await fetch(`/api/products/${id}`, { method: 'DELETE' });
          recentlyDeleted = null;
        }, 5000);
      }
  
      function undoDelete() {
        if (!recentlyDeleted) return;
        clearTimeout(deleteTimeout);
  
        const tbody = document.getElementById('productTableBody');
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${recentlyDeleted.name}</td>
          <td>${recentlyDeleted.price}</td>
          <td><button class="delete-btn" onclick="deleteProduct(${recentlyDeleted.id}, this)">Delete</button></td>
        `;
        if (tbody.children.length === 0 || recentlyDeleted.index >= tbody.children.length) {
          tbody.appendChild(row);
        } else {
          tbody.insertBefore(row, tbody.children[recentlyDeleted.index]);
        }
  
        toast(`Undo successful!`, true);
        recentlyDeleted = null;
      }
  
      document.getElementById('searchProductInput').addEventListener('input', function () {
        const term = this.value.toLowerCase();
        const filtered = allProducts.filter(p => p.name.toLowerCase().includes(term));
        renderProducts(filtered);
      });
  
      document.getElementById('addProductForm').addEventListener('submit', async function (e) {
        e.preventDefault();
        const name = document.getElementById('productName').value.trim();
        const price = parseFloat(document.getElementById('productPrice').value);
  
        if (!name || isNaN(price) || price <= 0) {
          return toast("Invalid input", false);
        }
  
        const res = await fetch('/api/products', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name, price })
        });
  
        const result = await res.json();
        if (result.success) {
          toast("Product added!");
          document.getElementById('addProductForm').reset();
          fetchProducts();
        } else {
          toast("Failed to add product.", false);
        }
      });
  
      window.onload = fetchProducts;
    </script>
  </body>
  </html>